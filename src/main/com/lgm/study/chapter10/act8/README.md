# 가능한 한 실패 원자적으로 만들라
### 실패 원자적(failure-atomic)
* 작업 도중 예외가 발생해도 그 객체가 여전히 정상적으로 사용할 수 있는 상태
* **호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 함**
### 실패 원자적으로 만들기
1. 불변객체
   * 가장 간단한 방법은 불변객체로 만드는 것
   * 불변객체는 태생적으로 **원자적**
2. 매개변수 유효성 검사
   * 가변 객체의 메서드를 실패 원자적으로 만드는 방법 = 작업 수행 전에 매개변수의 유효성을 검사하는 것
   * 객체의 내부 상태를 변경하기 전에 잠재적 예외의 가능성 대부분을 걸러낼 수 있는 방법
   * 예) `Stack.pop`
      ```java
     public Object pop() {
       if(size == 0)
           throw new EmptyStackException();
       Object result = elements[--size];
       elements[size] = null;
       return result;
     }
      ```
   * 처음 if문에서 size의 값을 확인하여 0이면 예외를 던짐
     * 이 부분을 제거하더라도 스택이 비어있다면 예외를 던짐
     * 다만, size값이 음수가 되어 다음번 호출도 실패하게 되며, 이때 던지는 `ArrayIndexOutOfBoundsException`은 어울리지 않다고 볼 수 있음
   * 이와 비슷한 취지로 실패할 가능성이 있는 모든 코드를 객체의 상태를 바꾸는 코드보다 앞에 배치하는 방법도 있음
3. 복구 코드
   * 작업 도중 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 되돌리는 방법
### 실패 원자성이 필수인지
* 실패 원자성을 만들기 위해선 비용이나 복잡도가 아주 큰 연산의 경우에는 필수가 아님
* 복구할 수 없는 에러는 실패 원자적으로 만들 필요 없음
* 예외가 발생하도 **객체는 이전 상태와 똑같이 유지되어야 함**
  * 이 규칙을 지키지 못한다면 실패 시의 객체 상태를 API 설명에 명시해야 함
---
[[Prev act >>]](../act7/README.md)  
[[Next act >>]](../act9/README.md)